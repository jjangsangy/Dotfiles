#!/usr/bin/env bash
# ==============================================================================
  readonly VERSION=0.1 BUILD="test"
# ==============================================================================
usage() {
    local progname="${argv[0]}"

    cat <<- DOCUMENT

    ${f[u]}AUTHOR:${f[_]}      Sang Han
    ${f[u]}CREATED:${f[_]}     06/29/2014
    ${f[u]}REVISION:${f[_]}    $VERSION-$BUILD

    ${f[u]}USAGE:${f[_]}
	    ${f[lightfg]}${f[progname]}${f[_]} ${f[blue]}[-h|--help]${f[_]} ${f[green]}[${f[_]}${f[blue]}[-p|--prefix]${f[_]} ${f[green]}package_base]${f[_]} ${f[red]}env${f[_]}

    ${f[u]}DESCRIPTION:${f[_]}
	    ${f[cyan]}Convenience wrapper for detecting and sourcing conda enviornments${f[_]}

    ${f[u]}OPTIONS:${f[_]} \
	${f[cyan]}
        -h --help:
            Outputs usage.
        -p --prefix:
            Specify custom prefix directory
	${f[_]}
    ${f[u]}ENVAR:${f[_]}
        CONDA_ENVS_PATH: ${f[blue]}${CONDA_ENVS_PATH}${f[_]}
	
        Prefix Default: ${f[red]}\$HOME/anaconda/envs${f[_]}

	DOCUMENT
}
# ==============================================================================
# Global Variables
# ==============================================================================
declare -r argv=("$(basename "${BASH_SOURCE}")" "$@")
declare -i argc="($#) + 1"


# Text Format Bindings
# ==============================================================================
# Note: This feature only works on BASH 4+.
#       Machines running earlier versions of the shell will output
declare -A f=(
       [u]=$(tput smul)
     [red]=$(tput setaf 1)
   [green]=$(tput setaf 2)
    [blue]=$(tput setaf 4)
    [cyan]=$(tput setaf 6)
 [lightfg]=$(tput setab 7)
       [_]=$(tput sgr0)
)

# ==============================================================================
# Functions
# ==============================================================================
function activate() {
    # Input Validation
    if ((argc-1 == 1)); then
        local venv=${argv[1]}
    else
        printf "\n${f[u]}%s${f[_]}\n\n" \
            "Please select an enviornment" >&2
        printf "${f[u]}PREFIX:${f[_]}\n%s \n\n" \
            "${f[cyan]}${env_path}${f[_]}" >&2

        # TODO: Replace with Indexed Array
        for envs in "${env_path}/"*; do
            if [ -r "${envs}/bin/activate" ]; then
                printf "${f[blue]}%s${f[_]}: " \
                    "${envs##*/}" >&2
                printf "%s" "$(${envs}/bin/python --version)"

            fi
        done
        return 1
    fi

    local activation="${env_path}/${venv}/bin/activate"
    if [ -f "${activation}" ]; then
        source "${activation}" "${venv}"
    fi
}

# ===============================================================================
# Parameters
# ===============================================================================
# Long Arguments
for arg; do
    declare delim=""
    case "$arg" in
        --help)     args="${args}-h ";;
        --prefix)   args="${args}-p ";;

         *) [ "${argv[i]:0:1}" = "-" ] || delim="\""
             args="${args}${delim}${arg}${delim} ";;
    esac
done; eval set -- $args

# Short Arguments
while getopts "p:h" OPTION; do
    case ${OPTION} in
        h) usage
           exit 0
            ;;
        p) readonly PREFIX="${OPTARG}"
            ;;
       \?) echo "Invalid option: -${OPTARG}" >&2
           exit 1
            ;;
    esac
done
    shift $(($OPTIND-1))

# ===============================================================================
# Main Function
# ===============================================================================
main() {
    # Check for Anaconda Directory
    local env_path=${PREFIX:="$HOME/anaconda/envs"}
    if ! [ -d "${env_path}" ]; then
        printf "No directory at %s\n" \
            "${f[red]}${env_path}${f[_]}" >&2
        return 1
    fi
    activate
}

# ===============================================================================
# Program Entry Point
# ===============================================================================
if [ "$0" = "${BASH_SOURCE}" ]; then
    main
fi
